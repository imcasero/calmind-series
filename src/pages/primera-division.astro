---
import Layout from "../layouts/Layout.astro";
import ClassificationTable from "../components/shared/ClassificationTable/ClassificationTable.astro";
import DivisionTabs from "../components/shared/DivisionTabs/DivisionTabs.tsx";
import LinkButton from "../components/shared/LinkButton/LinkButton.astro";
import { supabase } from "../lib/supabase";
import type { Player } from "../components/shared/ClassificationTable/ClassificationTable.astro";
import type { Participant } from "../components/shared/ParticipantsList/ParticipantsList.tsx";

// Fetch data from Supabase - Get the active season
const { data: activeSeasonData } = await supabase
  .from('seasons')
  .select('id, name')
  .eq('is_active', true)
  .single();

let primeraPlayers: Player[] = [];
let primeraParticipants: Participant[] = [];
let hasData = false;

if (activeSeasonData) {
  const { data: divisionData } = await supabase
    .from('divisions')
    .select('id')
    .eq('season_id', activeSeasonData.id)
    .eq('name', 'Primera')
    .single();

  if (divisionData) {
    const { data: participantsData } = await supabase
      .from('division_participants')
      .select(`
        id,
        matches_played,
        matches_won,
        matches_lost,
        points,
        trainers (
          id,
          name,
          twitch_url,
          twitter_url,
          instagram_url
        )
      `)
      .eq('division_id', divisionData.id)
      .order('points', { ascending: false })
      .order('matches_won', { ascending: false });

    if (participantsData && participantsData.length > 0) {
      hasData = true;
      primeraPlayers = participantsData.map((participant: any, index: number) => {
        const trainer = Array.isArray(participant.trainers)
          ? participant.trainers[0]
          : participant.trainers;

        return {
          id: index + 1,
          name: trainer?.name || 'Sin nombre',
          avatar: String(index + 1),
          pj: participant.matches_played,
          pg: participant.matches_won,
          pp: participant.matches_lost,
          points: participant.points,
          isChampion: index === 0,
          isPromoted: false,
        };
      });

      primeraParticipants = participantsData.map((participant: any, index: number) => {
        const trainer = Array.isArray(participant.trainers)
          ? participant.trainers[0]
          : participant.trainers;

        return {
          id: index + 1,
          name: trainer?.name || 'Sin nombre',
          avatar: String(index + 1),
          pj: participant.matches_played,
          pg: participant.matches_won,
          pp: participant.matches_lost,
          points: participant.points,
          twitchUrl: trainer?.twitch_url,
          twitterUrl: trainer?.twitter_url,
          instagramUrl: trainer?.instagram_url,
          isChampion: index === 0,
          isPromoted: false,
        };
      });
    }
  }
}
---

<Layout title="Primera DivisiÃ³n - CalMind Series">
  <main class="w-full">
    <!-- Hero Section -->
    <section class="relative w-full">
      <div class="mx-auto max-w-5xl px-4 pt-16 pb-20 md:pt-24 md:pb-28 text-center">
        <!-- Crown Emoji -->
        <div class="text-6xl mb-6">ğŸ‘‘</div>

        <h1 class="pokemon-title text-retro-gold-400 drop-shadow-md font-black tracking-wide text-5xl sm:text-6xl md:text-7xl leading-tight">
          PRIMERA DIVISIÃ“N
        </h1>
        <p class="pokemon-title text-white/95 drop-shadow font-extrabold text-2xl sm:text-3xl md:text-4xl mt-1">
          La Ã©lite de PokÃ©mon CalMind Series
        </p>
      </div>

      <div class="border-t-4 border-retro-gold-500 max-w-5xl mx-auto opacity-60"></div>
    </section>

    <!-- Call to Action Banner -->
    <section class="relative w-full">
      <div class="mx-auto max-w-5xl px-4 py-14 md:py-20">
        <div class="retro-border bg-gradient-to-r from-snuff-500 to-snuff-600 rounded-lg p-8 text-center text-white border-4 border-snuff-800 shadow-2xl">
          <div class="text-4xl mb-4">â­</div>
          <h2 class="pokemon-title text-retro-gold-300 drop-shadow-md font-black tracking-wide text-3xl md:text-4xl mb-4">
            Â¿ESTÃS LISTO PARA SER EL PRÃ“XIMO NÃšMERO 1?
          </h2>
          <p class="text-white/95 drop-shadow font-semibold text-lg mb-6">
            Demuestra que tienes lo necesario para llegar a la cima
          </p>
          <div class="flex justify-center">
            <div class="scale-110">
              <LinkButton text="INSCRÃBETE AL TORNEO" href="https://forms.gle/Ai7mZvu38nj85NiZ8" variant="yellow" newTab={true} />
            </div>
          </div>
        </div>
      </div>

      <div class="border-t-4 border-retro-gold-500 max-w-5xl mx-auto opacity-60"></div>
    </section>

    <!-- Tabs and Content -->
    <section class="relative w-full">
      <div class="mx-auto max-w-5xl px-4 py-14 md:py-20">
        <DivisionTabs
          client:load
          hasData={hasData}
          participants={primeraParticipants}
        >
          {hasData ? (
            <ClassificationTable players={primeraPlayers} showPromotionZones={false} />
          ) : (
            <div class="bg-jacksons-purple-800/80 rounded-lg border-4 border-yellow-400 p-8 text-center shadow-2xl">
              <div class="text-6xl mb-4">ğŸ†</div>
              <h3 class="text-2xl drop-shadow-md font-black tracking-wide text-yellow-300 mb-4">
                ClasificaciÃ³n
              </h3>
              <p class="text-white/95 drop-shadow font-semibold">
                La clasificaciÃ³n de la Primera DivisiÃ³n estarÃ¡ disponible cuando comience la temporada.
              </p>
            </div>
          )}
        </DivisionTabs>
      </div>
    </section>
  </main>
</Layout>