---
import Layout from "../layouts/Layout.astro";
import ClassificationTable from "../components/shared/ClassificationTable/ClassificationTable.astro";
import DivisionTabs from "../components/shared/DivisionTabs/DivisionTabs.tsx";
import LinkButton from "../components/shared/LinkButton/LinkButton.astro";
import { supabase } from "../lib/supabase";
import type { Player } from "../components/shared/ClassificationTable/ClassificationTable.astro";

// Fetch data from Supabase
const { data: activeSeasonData } = await supabase
  .from('seasons')
  .select('id, name')
  .eq('is_active', true)
  .single();

let segundaPlayers: Player[] = [];
let hasData = false;

if (activeSeasonData) {
  const { data: divisionData } = await supabase
    .from('divisions')
    .select('id')
    .eq('season_id', activeSeasonData.id)
    .eq('name', 'Segunda Divisi贸n')
    .single();

  if (divisionData) {
    const { data: participantsData } = await supabase
      .from('division_participants')
      .select(`
        id,
        matches_played,
        matches_won,
        matches_lost,
        points,
        trainers (
          id,
          name
        )
      `)
      .eq('division_id', divisionData.id)
      .order('points', { ascending: false })
      .order('matches_won', { ascending: false });

    if (participantsData && participantsData.length > 0) {
      hasData = true;
      segundaPlayers = participantsData.map((participant: any, index: number) => {
        const trainer = Array.isArray(participant.trainers)
          ? participant.trainers[0]
          : participant.trainers;

        return {
          id: index + 1,
          name: trainer?.name || 'Sin nombre',
          avatar: String(index + 1),
          pj: participant.matches_played,
          pg: participant.matches_won,
          pp: participant.matches_lost,
          points: participant.points,
          isPromoted: index < 2,
          isChampion: false,
        };
      });
    }
  }
}
---

<Layout title="Segunda Divisi贸n - CalMind Series">
  <main class="w-full">
    <!-- Hero Section -->
    <section class="relative w-full">
      <div class="mx-auto max-w-5xl px-4 pt-16 pb-20 md:pt-24 md:pb-28 text-center">
        <!-- Chart Emoji -->
        <div class="text-6xl mb-6"></div>

        <h1 class="pokemon-title text-retro-cyan-300 drop-shadow-md font-black tracking-wide text-5xl sm:text-6xl md:text-7xl leading-tight">
          SEGUNDA DIVISIN
        </h1>
        <p class="pokemon-title text-white/95 drop-shadow font-extrabold text-2xl sm:text-3xl md:text-4xl mt-1">
          Entrenadores prometedores que luchan por ascender
        </p>
      </div>

      <div class="border-t-4 border-retro-gold-500 max-w-5xl mx-auto opacity-60"></div>
    </section>

    <!-- Call to Action Banner -->
    <section class="relative w-full">
      <div class="mx-auto max-w-5xl px-4 py-14 md:py-20">
        <div class="retro-border bg-gradient-to-r from-retro-cyan-500 to-retro-cyan-600 rounded-lg p-8 text-center text-white border-4 border-retro-cyan-800 shadow-2xl">
          <div class="text-4xl mb-4"></div>
          <h2 class="pokemon-title text-retro-gold-300 drop-shadow-md font-black tracking-wide text-3xl md:text-4xl mb-4">
            隆TU MOMENTO DE BRILLAR HA LLEGADO!
          </h2>
          <p class="text-white/95 drop-shadow font-semibold text-lg mb-6">
            Asciende a Primera Divisi贸n y 煤nete a la 茅lite
          </p>
          <div class="flex justify-center">
            <div class="scale-110">
              <LinkButton text="LUCHAR POR EL ASCENSO" href="https://forms.gle/Ai7mZvu38nj85NiZ8" variant="yellow" newTab={true} />
            </div>
          </div>
        </div>
      </div>

      <div class="border-t-4 border-retro-gold-500 max-w-5xl mx-auto opacity-60"></div>
    </section>

    <!-- Tabs and Content -->
    <section class="relative w-full">
      <div class="mx-auto max-w-5xl px-4 py-14 md:py-20">
        <DivisionTabs client:load hasData={hasData}>
          {hasData ? (
            <ClassificationTable players={segundaPlayers} showPromotionZones={true} />
          ) : (
            <div class="bg-jacksons-purple-800/80 rounded-lg border-4 border-yellow-400 p-8 text-center shadow-2xl">
              <div class="text-6xl mb-4"></div>
              <h3 class="text-2xl drop-shadow-md font-black tracking-wide text-yellow-300 mb-4">
                Clasificaci贸n
              </h3>
              <p class="text-white/95 drop-shadow font-semibold">
                La clasificaci贸n de la Segunda Divisi贸n estar谩 disponible cuando comience la temporada.
              </p>
            </div>
          )}
        </DivisionTabs>
      </div>
    </section>
  </main>
</Layout>